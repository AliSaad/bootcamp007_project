---
title: "shopaholicsEDA"
author: "Jhonasttan Regalado"
date: "12/3/2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Documents/DataScience/bootcamp7/githubcrush/bootcamp007_project/Project5-Capstone/shopaholics/BX-CSV-Dump/")
```

Load libraries
```{r, echo=FALSE}
library(tidyverse)
library(ggmap)
library(ggplot2)
library(anytime)
library(lubridate)
library(leaflet)

```

Load user data into dataframe and capture geospatial locations
```{r}


users <- read.csv("./BX-Users.csv", sep = ";", header = TRUE, stringsAsFactor=FALSE, quote="\"", encoding = "Latin-1") #encoding="UTF-8")
str(users)

locations <- users %>% group_by(Location) %>% count() %>% arrange(desc(n))

userLocationGeoSpatial <- function(x) {
  address <- geocode(location = x)
}

#get address geolocations
#for (i in seq_along(locations$Location)) {
for (i in seq(77,600)) {
  locationGeocode <- c(0.0,0.0)
  
  locationGeocode <- tryCatch(
    userLocationGeoSpatial(locations$Location[i]), 
    error=function(e) NULL
    )
  
  if (locationGeocode[1] != 0.0) {
    locations$lon[i] <- locationGeocode[[1]]
    locations$lat[i] <- locationGeocode[[2]]
  }
  
  Sys.sleep(1)
}

write.csv(locations[1:75,], file = './locations.csv')

#find rows where values equal integers << breaks - may need to remove some rows
for (i in seq_along(users$Age)) {
  if (is.integer(as.integer(users$Age[i]))) {
    users$AgeInt[i] <- tryCatch(as.integer(users$Age[i]),
                                error=function(e) NULL
                                )
  }
}

users$User.ID <- as.integer(users$User.ID)
```

Load books
```{r}
books <- read.csv("./BX-Books-munged.csv",sep = ";", header = TRUE, stringsAsFactor=FALSE, quote="\"")
#books <- read.csv("./BX-Books-munged.csv",sep = ";", header = TRUE)
books$Year.Of.Publication <-  lubridate::year(anydate(books$Year.Of.Publication))


```

Load ratings
```{r}
ratings <- read.csv("./BX-Book-Ratings.csv", sep = ";", header = TRUE, stringsAsFactor=FALSE)

```

EDA

Summary:
```{r}
summary(books)
str(books)
#books$Year.Of.Publication <- as.Date(books$Year.Of.Publication, "%Y")
head(books)
summary(users)
head(users)
summary(ratings)
str(books)
```
Books 
```{r}
summary(books$Year.Of.Publication)
ggplot(books,aes(Year.Of.Publication)) + geom_histogram()
filter(books,Year.Of.Publication == 2050)
filter(books,Year.Of.Publication != 2050) %>% ggplot(.,aes(Year.Of.Publication)) + geom_histogram()
books %>% group_by(Year.Of.Publication) %>% count() %>% top_n(.,10) %>% arrange(desc(n))
```

Map locations
```{r}
#set leaflet map tile
tile_layer <- "https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiamhvbmFzdHRhbiIsImEiOiJFLTAzeVVZIn0.mwAAfKtGwv3rs3L61jz87A"

# leaflet(data = users) %>% 
#   addTiles(urlTemplate = tile_layer) %>% 
#   addMarkers(popup = paste0("Station: ", leaflet_info$stationName,
#                             "<br>Bikes: ", leaflet_info$availableBikes, " / Docks: ",
#                             leaflet_info$availableDocks, " / Total Docks: ", leaflet_info$totalDocks)) %>%
#   addCircles(lat = leaflet_info[1:length(input$selected),'latitude'], 
#              lng = leaflet_info[1:length(input$selected),'longitude'],
#              weight = leaflet_info$availableBikes, radius = leaflet_info$availableDocks / input$docksAvailable, 
#              color =  ifelse(leaflet_info$availableBikes >= input$bikesAvailable,"green","red"),
#              #weight = 1, radius = ((leaflet_info$availableBikes + leaflet_info$availableDocks) * 5 ), color =  "black",
#              fillColor = "orange", fillOpacity=0.5, opacity=1) %>%
# setView(lng = -73.976522, lat = 40.7528, zoom = input$zoom)

leaflet(data = locations[1:75,c("Location","lon","lat")]) %>% 
  addTiles(urlTemplate = tile_layer) %>% 
  addMarkers(popup = locations$Location) # %>%
  #setView(lng = -73.976522, lat = 40.7528, zoom = 12)
```

Ratings

```{r}
ggplot(ratings, aes(Book.Rating)) + geom_histogram()
```

